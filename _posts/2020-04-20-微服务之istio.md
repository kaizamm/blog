---
layout: post
published: false
title:  微服务之istio介绍
categories: [微服务]
tags: [istio]
---
* content
{:toc}

# 前言

[官网](https://istio.io/)

istio的编程语言 go


# 什么是service mesh

The term service mesh is used to describe the network of microservices that make up such applications and the interactions between them. As a service mesh grows in size and complexity, it can become harder to understand and manage. Its requirements can include discovery, load balancing, failure recovery, metrics, and monitoring. A service mesh also often has more complex operational requirements, like A/B testing, canary rollouts, rate limiting, access control, and end-to-end authentication.

服务网格，由应用及它们之间的交互组成的微服务网络。

# 什么是istio

istio is an open platform for providing a uniform way to integrate microservices, manage traffic flow across microservices, enforce policies and aggregate telemetry data. Istio's control plane provides an abstraction layer over the underlying cluster management platform, such as Kubernetes.

**Istio is composed of these components**:

- Envoy - Sidecar proxies per microservice to handle ingress/egress traffic between services in the cluster and from a service to external services. The proxies form a secure microservice mesh providing a rich set of functions like discovery, rich layer-7 routing, circuit breakers, policy enforcement and telemetry recording/reporting functions.

>Note: The service mesh is not an overlay network. It simplifies and enhances how microservices in an application talk to each other over the network provided by the underlying platform.

- Mixer - Central component that is leveraged by the proxies and microservices to enforce policies such as authorization, rate limits, quotas, authentication, request tracing and telemetry collection. （在1.5版本中deprecated）

- Pilot - A component responsible for configuring the proxies at runtime.

- Citadel - A centralized component responsible for certificate issuance and rotation.

- Citadel Agent - A per-node component responsible for certificate issuance and rotation.

- Galley- Central component for validating, ingesting, aggregating, transforming and distributing config within Istio. 验证istio配置

- Operator- The component provides user friendly options to operate the Istio service mesh. （deprecated in 1.5）

# Tasks
## Traffic Management 流量管理
主要功能提现在流量管理上面

功能：

https://istio.io/docs/tasks/traffic-management/

+ Request Routing 配置请求路由

+ Fault Injectiong 错误注入

+ Traffic Shifting 流量转移

+ Tcp Traffic Shifting TCP流量转移

+ Request timeouts  超时

+ Circuit Breaking  熔断

+ Mirroring  流量镜像

相关资源：

https://istio.io/docs/concepts/traffic-management/

+ Virtual services

+ Destination rules

+ Gateways

+ Service entries

+ Sidecars


## security 安全
认证 鉴权
## 策略 polices(deprecated in 1.5)
## observability 可观察性
度量 日志 分布式追踪 网格可视化
# Repositories

[github](https://github.com/istio/istio)

The Istio project is divided across a few GitHub repositories.

- istio/istio. This is the main repository that you are currently looking at. It hosts Istio's core components and also the sample programs and the various documents that govern the Istio open source project. It includes:

    - security. This directory contains security related code, including Citadel (acting as Certificate Authority), citadel agent, etc.

    - pilot. This directory contains platform-specific code to populate the abstract service model, dynamically reconfigure the proxies when the application topology changes, as well as translate routing rules into proxy specific configuration.

    - istioctl. This directory contains code for the istioctl command line utility.

    - mixer. This directory contains code to enforce various policies for traffic passing through the proxies, and collect telemetry data from proxies and services. There are plugins for interfacing with various cloud platforms, policy management services, and monitoring services.

- istio/api. This repository defines component-level APIs and common configuration formats for the Istio platform.

- istio/proxy. The Istio proxy contains extensions to the Envoy proxy (in the form of Envoy filters), that allow the proxy to delegate policy enforcement decisions to Mixer.


# 安装

安装分两步，先安装istioctl，然后安装相应的组件。

1. 安装istioctl

```
$ curl -L https://istio.io/downloadIstio | sh -
```

> 这个是安装最新版本，安装其他版本，可以直接加版本号
```
$ curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.5.2 sh -
```

2. 安装组件

```
$ istioctl manifest apply --set profile=default

```


看下 1.5.2  svc/deployments/pods

```
[root@ks-allinone ~]# istioctl version
client version: 1.5.2
control plane version: 1.5.2
data plane version: 1.5.2 (2 proxies)
[root@ks-allinone ~]# kubectl get svc -n istio-system
NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                                                                                      AGE
istio-ingressgateway   LoadBalancer   10.233.58.205   <pending>     15020:30221/TCP,80:30871/TCP,443:31173/TCP,15029:32352/TCP,15030:30281/TCP,15031:32553/TCP,15032:32514/TCP,15443:32616/TCP,31400:32642/TCP   33m
istio-pilot            ClusterIP      10.233.35.184   <none>        15010/TCP,15011/TCP,15012/TCP,8080/TCP,15014/TCP,443/TCP                                                                                     33m
istiod                 ClusterIP      10.233.46.85    <none>        15012/TCP,443/TCP                                                                                                                            33m
prometheus             ClusterIP      10.233.31.81    <none>        9090/TCP                                                                                                                                     33m
[root@ks-allinone ~]# kubectl get deploy -n istio-system
NAME                   READY   UP-TO-DATE   AVAILABLE   AGE
istio-ingressgateway   1/1     1            1           33m
istiod                 1/1     1            1           33m
prometheus             1/1     1            1           33m
[root@ks-allinone ~]# kubectl get po -n istio-system
NAME                                    READY   STATUS    RESTARTS   AGE
istio-ingressgateway-64f6f9d5c6-vspf6   1/1     Running   0          33m
istiod-5bb879d86c-br4pr                 1/1     Running   0          33m
prometheus-77b9c64b9c-nlpvg             2/2     Running   0          33m
```

再看下1.3.3版本的 svc/deployments/pods

```
root@master1:~# istioctl version
client version: 1.3.3
control plane version: 1.3.3

root@master1:~# kubectl get svc -n istio-system
NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                                                                                                      AGE
istio-citadel               ClusterIP   10.233.51.87    <none>        8060/TCP,15014/TCP                                                                                                                           24d
istio-galley                ClusterIP   10.233.23.10    <none>        443/TCP,15014/TCP,9901/TCP                                                                                                                   24d
istio-ingressgateway        NodePort    10.233.50.199   <none>        15020:30213/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31381/TCP,15030:32667/TCP,15031:30799/TCP,15032:32463/TCP,15443:31675/TCP   24d
istio-pilot                 ClusterIP   10.233.12.158   <none>        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                                       24d
istio-policy                ClusterIP   10.233.34.122   <none>        9091/TCP,15004/TCP,15014/TCP                                                                                                                 24d
istio-sidecar-injector      ClusterIP   10.233.30.165   <none>        443/TCP,15014/TCP                                                                                                                            24d
istio-telemetry             ClusterIP   10.233.38.107   <none>        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                                       24d
jaeger-collector            ClusterIP   10.233.40.2     <none>        9411/TCP,14250/TCP,14267/TCP,14268/TCP                                                                                                       24d
jaeger-collector-headless   ClusterIP   None            <none>        9411/TCP,14250/TCP,14267/TCP,14268/TCP                                                                                                       24d
jaeger-operator             ClusterIP   10.233.42.74    <none>        8383/TCP                                                                                                                                     24d
jaeger-operator-metrics     ClusterIP   10.233.55.162   <none>        8383/TCP                                                                                                                                     24d
jaeger-query                ClusterIP   10.233.14.223   <none>        16686/TCP                                                                                                                                    24d

root@master1:~# kubectl get deploy -n istio-system
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
istio-citadel            1/1     1            1           22d
istio-galley             1/1     1            1           22d
istio-ingressgateway     1/1     1            1           22d
istio-pilot              1/1     1            1           22d
istio-policy             1/1     1            1           22d
istio-sidecar-injector   1/1     1            1           22d
istio-telemetry          1/1     1            1           22d
jaeger-collector         1/1     1            1           21d
jaeger-operator          1/1     1            1           22d
jaeger-query             1/1     1            1           21d

root@master1:~# kubectl get po -n istio-system
NAME                                    READY   STATUS      RESTARTS   AGE
istio-citadel-bf7f55fb7-mdlpp           1/1     Running     0          21d
istio-galley-5958487d5c-v8tnh           1/1     Running     0          21d
istio-ingressgateway-57df6b4c9f-9crlq   1/1     Running     0          21d
istio-init-crd-10-1.3.3-4mxjv           0/1     Completed   0          21d
istio-init-crd-11-1.3.3-q7vbj           0/1     Completed   0          21d
istio-init-crd-12-1.3.3-xs2vw           0/1     Completed   0          21d
istio-pilot-65668bcb-jwgnj              2/2     Running     0          21d
istio-policy-b8648ffd5-z7b86            2/2     Running     1          21d
istio-sidecar-injector-74b777cd-pqkq6   1/1     Running     0          21d
istio-telemetry-795466fc84-8q2hp        2/2     Running     10         21d
jaeger-collector-544bdd5f9f-f5n56       1/1     Running     14         21d
jaeger-operator-bdbb4954b-dj62d         1/1     Running     0          21d
jaeger-query-5d86f5fcf-n9v4n            2/2     Running     14         21d
```

对比可以发现有很大的变化，原因是istio 1.5开始回归单体，把控制平面的组件合成了一个istiod，并移除了mixer遥测组件。



# 看istio的架构

![arc](/styles/images/istio-arch.svg)

这副图很形象说明了各组件的关系。

网关：  ingress/egress

数据平面：  envroy proxy，依赖于sidecars, 负责workload的业务逻辑消息之间的收发。

控制平面： istiod(pilot/citadel/Galley), 管理流量路由 traffic route 。

# Envoy proxy

用c++实现的一个高性能proxy。能达到以下功能：

+ Dynamic service discovery
+ Load balancing
+ TLS termination
+ HTTP/2 and gRPC proxies
+ Health checks
+ Fault injection

[Envory official site](https://www.envoyproxy.io/docs/envoy/latest/about_docs)

# Pilot

Pilot provides service discovery for the Envoy sidecars, traffic management capabilities for intelligent routing (e.g., A/B tests, canary rollouts, etc.), and resiliency (timeouts, retries, circuit breakers, etc.).

![pilot](/styles/images/pilot.svg)

1. The platform starts a new instance of a service which notifies its platform adapter.

2. The platform adapter registers the instance with the Pilot abstract model.

3. Pilot distributes traffic rules and configurations to the Envoy proxies to account for the change.

[Envoy API](https://www.envoyproxy.io/docs/envoy/latest/api/api)

# Citadel

Citadel enables strong service-to-service and end-user authentication with built-in identity and credential management. You can use Citadel to upgrade unencrypted traffic in the service mesh. Using Citadel, operators can enforce policies based on service identity rather than on relatively unstable layer 3 or layer 4 network identifiers. Starting from release 0.5, you can use Istio’s authorization feature to control who can access your services.

# Galley

Galley is Istio’s configuration validation, ingestion, processing and distribution component. It is responsible for insulating the rest of the Istio components from the details of obtaining user configuration from the underlying platform (e.g. Kubernetes).

隔离用户与平台组件的配置

# 设计思想

大规模服务治理能力和高性能

1. Maximize Transparency 最大程度透明性

To adopt Istio, an operator or developer is required to do the minimum amount of work possible to get real value from the system. To this end, Istio can automatically inject itself into all the network paths between services. Istio uses sidecar proxies to capture traffic and, where possible, automatically program the networking layer to route traffic through those proxies without any changes to the deployed application code. In Kubernetes, the proxies are injected into pods and traffic is captured by programming iptables rules. Once the sidecar proxies are injected and traffic routing is programmed, Istio can mediate all traffic. This principle also applies to performance. When applying Istio to a deployment, operators see a minimal increase in resource costs for the functionality being provided. Components and APIs must all be designed with performance and scale in mind.

2. Extensibility 可扩展性

3. portability 可移植性

4. Policy Uniformity 策略一致性

The application of policy to API calls between services provides a great deal of control over mesh behavior. However, it can be equally important to apply policies to resources which are not necessarily expressed at the API level. For example, applying a quota to the amount of CPU consumed by an ML training task is more useful than applying a quota to the call which initiated the work. To this end, Istio maintains the policy system as a distinct service with its own API rather than the policy system being baked into the proxy sidecar, allowing services to directly integrate with it as needed.

将策略应用于服务之间的 API 调用提供了对网格行为的大量控制。然而，将策略应用在区别于 API 层上的资源也同样重要。例如，在机器学习训练任务消耗的 CPU 数量上应用配额比在发起任务的请求调用上应用配额更有用。为此，Istio 使用自己的 API 将策略系统维护为一个独立的服务，而不是将策略系统集成到 sidecar 代理中，从而允许服务根据需要直接与之集成。

# 性能

The Istio load tests mesh consists of 1000 services and 2000 sidecars with 70,000 mesh-wide requests per second. After running the tests using Istio 1.5.1, we get the following results:

The Envoy proxy uses 0.5 vCPU and 50 MB memory per 1000 requests per second going through the proxy.
The istio-telemetry service uses 0.6 vCPU per 1000 mesh-wide requests per second.
Pilot uses 1 vCPU and 1.5 GB of memory.
The Envoy proxy adds 2.8 ms to the 90th percentile latency.

# reference

reference列出了所有的配置和命令。

https://istio.io/docs/reference


# QA

+ 1.5的架构做了改变，变成回归单体，是什么意思？
  是指控制平面把其他组件(pilot/citadel/galley/sidecar injector)合成了一个istiod。

  之前的架构
  ![以前的架构](/styles/images/architecture-pre-istiod.svg)

  现在的架构
  ![现在的istiod](/styles/images/architecture-post-istiod.svg)

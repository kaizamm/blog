---
layout: post
title:  kvm安装及虚拟机创建
date:   2018-05-23  
categories: project
tag:
  - kvm
  - 虚拟化
  - 云计算

---
* content
{:toc}

### 系统环境
Vmware Workstation<br>
系统版本：CentOS Linux release 7.5.1804 (Core)<br>
内存：4GB<br>
额外：勾选vt-x<br>
bonding<br>
注意：vmare的网关为x.x.x.2，所以nameserver也要设置为x.x.x.2<br>

### 查看是否支持硬件虚拟化
确定机器有VT,如果flags: 里有vmx 或者svm就说明支持VT；如果没有任何的输出，说明你的cpu不支持，将无法使用KVM虚拟机。
```
grep -E -o '(vmx|svm)' /proc/cpuinfo
```

确保BIOS里开启VT:
```
Intel(R) Virtualization Tech [Enabled]
```

查看内核中是否有KVM模块
```
#lsmod|grep kvm
kvm_intel             148081  0
kvm                   461126  1 kvm_intel
```
出现这个结果表示kvm模块已经加载，kvm是linux内核中的一个模块，无需安装只需加载，若未出现上述结果，可直接从内核加载，加载命令如下
```
# modprobe kvm
# modprobe kvm_intel
```

### 桥接网络
1. 为什么要桥接网络？<br>
因为虚拟机中网络，我们一般都是和公司的其他服务器是同一个网段，所以我们需要把KVM服务器的网卡配置成桥接模式。这样的话KVM的虚拟机就可以通过该桥接网卡和公司内部分其他服务器处于同一网段。

2. 为什么将本地网卡加入到网桥后，本地网卡无需IP？网桥如何配置IP<br>
将已有的物理网卡添加到网桥，此时物理网卡eth0工作于混杂模式，所以不需要IP地址，因为网桥是工作在链路层的。br0就提供了IP地址，用来模拟原来的物理网卡的访问接口.

首先安装网桥工具
```
yum install bridge-utils -y
```

方法一：修改配置文件，永久生效

1. 若未做bond，则直接修改网卡配置
复制ifcfg-eth0 为 ifcfg-br0，并将ifcfg-br0改为如下配置
```
tee /etc/sysconfig/network-scripts/ifcfg-br0 <<EOF
TYPE=Bridge
BOOTPROTO=static
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
IPV4_FAILURE_FATAL=no
NAME=br0
DEVICE=br0
ONBOOT=yes
IPADDR=192.168.56.13
NETMASK=255.255.255.0
GATEWAY=192.168.56.2
EOF
```
原网卡ifcfg-em1只保留如下配置,其他都注释掉：
```
tee /etc/sysconfig/network-scripts/ifcfg-eth0<<EOF
NAME=eth0
DEVICE=eth0
ONBOOT=yes
BRIDGE=br0
EOF
```

2. 若做了bond，则做如下配置，至于bond的配置请看[往期博客，bond的配置](https://kaizamm.github.io/2018/05/16/linux%E7%9A%84bonding%E6%8A%80%E6%9C%AF/)
```
tee ifcfg-bond0 <<EOF
DEVICE=bond0
TYPE=Ethernet
NAME=bond0
BONDING_MASTER=yes
BOOTPROTO=none
BRIDGE=br0
ONBOOT=yes
BONDING_OPTS="mode=5 miimon=100"
EOF
```

重启网卡
```
systemctl restart network
```

方法二：

临时生效，通过ifconfig命令配置网卡及网桥参考[往期博客，网桥及路由配置](https://kaizamm.github.io/2018/05/21/linux%E4%B8%8B%E7%BD%91%E6%A1%A5%E5%8F%8A%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE/)


### 安装kvm及libvirt
[参考](https://blog.csdn.net/wh211212/article/details/54141412)

libvirt是管理虚拟机的API库，不仅支持KVM虚拟机，也可以管理Xen等方案下的虚拟机
```
yum install -y kvm qemu-kvm python-virtinst libvirt libvirt-python virt-manager libguestfs-tools bridge-utils virt-install bridge-utils
```
+ kvm基础包
+ qemu-kvm: 主要的kvm程序包
+ pyhon-virtinst： 创建虚拟机所需要的命令行工具和程序库
+ libvirt: C语言工具包，提供libvirt服务
+ virt-manager: 图形界面GUI管理工具
+ libguestfs* : virt-cat等命令的支持软件包
+ virt-install: 基于libvirt服务的虚拟机创建命令
+ birdeg-utils: 创建和管理桥接设备的工具


启动kvm
```
systemctl start libvirtd  &&  systemctl enable libvirtd
```

### 创建虚拟机

首先安装前要设置环境语言为英文LANG="en_US.UTF-8"，
```
#cat /etc/locale.conf
LANG="en_US.UTF-8"
```

通过网络在文本模式上安装GuestOS，虚拟机的映像默认放置在/var/lib/libvirt/images作为存储池

```
virt-install \
--name kvm-centos7-node1 \
--disk size=10 \
--memory 512 \
--vcpus 1 \
--os-type linux \
--os-variant rhel7 \
--network bridge=br0 \
--graphics none \
--console pty,target_type=serial \
--location 'http://mirrors.aliyun.com/centos/7/os/x86_64/' \
--extra-args 'console=ttyS0,115200n8 serial'
```
若要使用新的存储池，则要新创建对对应的目录后，disk path参数，如下：
```
--disk path=/var/kvm/images/elk.img,size=30 \
```

>上面指定的相关参数含义如下：更多参考man virt-install

```
--name  指定虚拟机的名称
--memory  指定虚拟机内存
--disk的内存量path = xxx，size = xxx
'path ='⇒指定虚拟机
'size ='⇒指定虚拟机的磁盘大小
--vcpus 指定虚拟CPU
--os-type 指定GuestOS 的类型
--os-variant 指定GuestOS的类型 'fedora18', 'rhel7', 'winxp' - osinfo-query os 该命令可查看所有供选择的
--network 指定虚拟机的网络类型
--graphics 指定图形的类型。如果设置为“无”，则意味着非图形。
--console 指定控制台类型
--location 指定安装的位置,可直接指定本地镜像路径，尽量使用本地镜像，网络镜像本地测试未通过，测试通过的为"--location=/tmp/CentOS-7-x86_64-Minimal-1804.iso"
--extra-args 指定在内核中设置的参数
```


<img src="{{ '/styles/images/kvm20180524-1.png' | prepend: site.baseurl }}" alt="" width="610" />

如填写感叹号项，时区、语言、存储等，按照提示安装

安装成功后进入会直接进入刚创建的虚机，需设置IP，方便之后ssh登陆。由于网络是桥接模式，故将IP设置为跟宿主机同网段，NETMASK及GATEWAY与宿主机设置成一样，如下：
```
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
TYPE=Ethernet
BOOTPROTO=static
NAME=eth0
UUID=a75fcb3e-4f10-4ab1-bafa-45a3549a13b4
DEVICE=eth0
ONBOOT=yes
IPADDR=192.168.56.21
NETMASK=255.255.255.0
GATEWAY=192.168.56.2
DNS1=192.168.56.2
```
重启网络后就可以ssh登陆了

```
[root@localhost ~]# who
root     ttyS0        2018-06-01 15:30
root     pts/0        2018-06-01 15:26 (192.168.56.11)
```
tty用户只能登出，若要是回到宿主机，要在pts端exit才行。<p>
同样，关闭selinx、firewalld，然后制作快照
```
[root@localhost ~]# virsh snapshot-create kvm-centos7-node2
已生成域快照 1527863380
```
查看生成的快照xml文件
```
[root@localhost libvirt]# cat /var/lib/libvirt/qemu/snapshot/kvm-centos7-node2/1527863380.xml
<!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh snapshot-edit
or other application using the libvirt API.
-->

<domainsnapshot>
  <name>1527863380</name>
  <state>running</state>
  <creationTime>1527863380</creationTime>
  <memory snapshot='internal'/>
  <disks>
    <disk name='vda' snapshot='internal'/>
    <disk name='hda' snapshot='no'/>
  </disks>
  <domain type='kvm'>
    <name>kvm-centos7-node2</name>
    <uuid>37ddb449-eed4-4503-8a20-fa213dd3d20a</uuid>
    <memory unit='KiB'>524288</memory>
    <currentMemory unit='KiB'>524288</currentMemory>
    <vcpu placement='static'>1</vcpu>
    <resource>
      <partition>/machine</partition>
    </resource>
    <os>
      <type arch='x86_64' machine='pc-i440fx-rhel7.0.0'>hvm</type>
      <boot dev='hd'/>
    </os>
    <features>
      <acpi/>
      <apic/>
    </features>
    <cpu mode='custom' match='exact' check='partial'>
      <model fallback='forbid'>Broadwell</model>
      <feature policy='disable' name='hle'/>
      <feature policy='disable' name='rtm'/>
    </cpu>
    <clock offset='utc'>
      <timer name='rtc' tickpolicy='catchup'/>
      <timer name='pit' tickpolicy='delay'/>
      <timer name='hpet' present='no'/>
    </clock>
    <on_poweroff>destroy</on_poweroff>
    <on_reboot>restart</on_reboot>
    <on_crash>destroy</on_crash>
    <pm>
      <suspend-to-mem enabled='no'/>
      <suspend-to-disk enabled='no'/>
    </pm>
    <devices>
      <emulator>/usr/libexec/qemu-kvm</emulator>
      <disk type='file' device='disk'>
        <driver name='qemu' type='qcow2'/>
        <source file='/var/lib/libvirt/images/kvm-centos7-node2.qcow2'/>
        <target dev='vda' bus='virtio'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>
      </disk>
      <disk type='file' device='cdrom'>
        <driver name='qemu' type='raw'/>
        <target dev='hda' bus='ide'/>
        <readonly/>
        <address type='drive' controller='0' bus='0' target='0' unit='0'/>
      </disk>
      <controller type='usb' index='0' model='ich9-ehci1'>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x7'/>
      </controller>
      <controller type='usb' index='0' model='ich9-uhci1'>
        <master startport='0'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0' multifunction='on'/>
      </controller>
      <controller type='usb' index='0' model='ich9-uhci2'>
        <master startport='2'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x1'/>
      </controller>
      <controller type='usb' index='0' model='ich9-uhci3'>
        <master startport='4'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x2'/>
      </controller>
      <controller type='ide' index='0'>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x1'/>
      </controller>
      <controller type='virtio-serial' index='0'>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0'/>
      </controller>
      <controller type='pci' index='0' model='pci-root'/>
      <interface type='bridge'>
        <mac address='52:54:00:e9:65:f5'/>
        <source bridge='br0'/>
        <model type='virtio'/>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
      </interface>
      <serial type='pty'>
        <target type='isa-serial' port='0'>
          <model name='isa-serial'/>
        </target>
      </serial>
      <console type='pty'>
        <target type='serial' port='0'/>
      </console>
      <channel type='unix'>
        <target type='virtio' name='org.qemu.guest_agent.0'/>
        <address type='virtio-serial' controller='0' bus='0' port='1'/>
      </channel>
      <input type='mouse' bus='ps2'/>
      <input type='keyboard' bus='ps2'/>
      <memballoon model='virtio'>
        <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>
      </memballoon>
    </devices>
    <seclabel type='dynamic' model='selinux' relabel='yes'/>
  </domain>
  <cookie>
    <cpu mode='custom' match='exact' check='full'>
      <model fallback='forbid'>Broadwell</model>
      <feature policy='disable' name='hle'/>
      <feature policy='disable' name='rtm'/>
      <feature policy='require' name='hypervisor'/>
      <feature policy='require' name='xsaveopt'/>
    </cpu>
  </cookie>
  <active>1</active>
</domainsnapshot>
```
### 利用配置文件来创建虚机
在/etc/libvirt/qemu下新建xml文件，如node.xml。需要有内存、cpu、硬盘设置、光驱以及vnc等等,可以利用以上快照xml文件
```
virsh create x.xml
```
代码分析：　
```

　　1.<domain type='kvm'>  　　　　　　　　　　　　　　　　           域类型，也可以是xen

　　2.<name>node3</name> 　　　　　　　　　　　　　　　　         虚拟机的名字

　　3.<memory unit='KiB'>524288</memory>  　　　　　　　         虚拟机的最大内存

　　4.<currentMemory unit='KiB'>524288</currentMemory> 　　　 虚拟机当前的内存

　　5.<vcpu>2</vcpu> 　　　　　　　　　　　　　　　　　　　　　　 该虚拟机的cpu数

　　6.<boot dev='hd'/> 　　　　　　　　　　　　　　　　　　　　　　hd表示从硬盘启动，cdrom表示从光盘启动

　　7.<type arch='x86_64' machine='rhel6.5.0'>hvm</type>　　　表示全虚拟化

　　其实还有好多其他的属性：

　　1.<console type='pty'> 　　　　　　　　　　　　　　　　　　　   console用来代表交互性的控制台

　　2.<interface type='bridge'>   　　　　　　　　　　　　　　　　　 网桥

　　3.<source bridge='virbr0'/>　　　　　　　　　　　　　　　　　　 网桥名

　　4.<mac address='00:16:36:1e:1d:04'/>　　　　　　　　　　　 MAC地址

　　5.<graphics type='vnc' autoport='yes' keymap='en-us'/>       图形类型
```

###  virsh命令
查看虚机
```
virsh list
```

强制关闭
```
[root@localhost ~]# virsh destroy demo
域 demo 被删除

[root@localhost ~]# virsh list --all
 Id    名称                         状态
 -     demo                           关闭
```

删除虚机
```

[root@localhost ~]# virsh undefine demo
域 demo 已经被取消定义

[root@localhost ~]# virsh list --all
 Id    名称                         状态
----------------------------------------------------

```
其他操作
```
virsh start x                                 　　　　启动名字为x的非活动虚拟机

virsh create x.xml                   　　　　　  创建虚拟机（创建后，虚拟机立即执行，成为活动主机）

virsh suspend x                            　　　　暂停虚拟机

virsh resume x                             　　　　启动暂停的虚拟机

virsh shutdown x                    　　 　　　正常关闭虚拟机

virsh destroy x                             　　　　强制关闭虚拟机

virsh dominfo x                              　　　显示虚拟机的基本信息

virsh domname 2                                   显示id号为2的虚拟机名

virsh domid x                                　　　显示虚拟机id号

virsh domuuid x                             　　显示虚拟机的uuid

virsh domstate x                         　　　 显示虚拟机的当前状态

virsh dumpxml x                            　　显示虚拟机的当前配置文件（可能和定义虚拟机时的配置不同，因为当虚拟机启动时，需要给虚拟机分配id号、uuid、vnc端口号等等）

virsh setmem x 512000                  　　给不活动虚拟机设置内存大小

virsh edit x                                   　　编辑配置文件（一般是在刚定义完虚拟机之后）
```

### virt-manager图形化工具
要求使用带有图形化界面的linux，未验证，安装方法跟普通vm安装类似，如果要安装windows的虚拟机，需安装vnc

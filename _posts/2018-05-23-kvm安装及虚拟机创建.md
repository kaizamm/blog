---
layout: post
title:  kvm安装及虚拟机创建
date:   2018-05-23  
categories: project
tag:
  - kvm
  - 虚拟化
  - 云计算

---
* content
{:toc}

### 系统环境
Vmware Workstation<br>
系统版本：CentOS Linux release 7.5.1804 (Core)<br>
内存：4GB<br>
额外：勾选vt-x<br>
bonding<br>
注意：vmare的网关为x.x.x.2，所以nameserver也要设置为x.x.x.2<br>

### 安装KVM Qemu Libvi

### 查看是否支持硬件虚拟化
确定机器有VT,如果flags: 里有vmx 或者svm就说明支持VT；如果没有任何的输出，说明你的cpu不支持，将无法使用KVM虚拟机。
```
grep -E -o '(vmx|svm)' /proc/cpuinfo
```

确保BIOS里开启VT:
```
Intel(R) Virtualization Tech [Enabled]
```

查看内核中是否有KVM模块
```
#lsmod|grep kvm
kvm_intel             148081  0
kvm                   461126  1 kvm_intel
```
出现这个结果表示kvm模块已经加载，kvm是linux内核中的一个模块，无需安装只需加载，若未出现上述结果，可直接从内核加载，加载命令如下
```
# modprobe kvm
# modprobe kvm_intel
```


### 桥接网络
1. 为什么要桥接网络？<br>
因为虚拟机中网络，我们一般都是和公司的其他服务器是同一个网段，所以我们需要把KVM服务器的网卡配置成桥接模式。这样的话KVM的虚拟机就可以通过该桥接网卡和公司内部分其他服务器处于同一网段。

2. 为什么将本地网卡加入到网桥后，本地网卡无需IP？网桥如何配置IP<br>
将已有的物理网卡添加到网桥，此时物理网卡eth0工作于混杂模式，所以不需要IP地址，因为网桥是工作在链路层的。br0就提供了IP地址，用来模拟原来的物理网卡的访问接口.

首先安装网桥工具
```
yum install bridge-utils -y
```


方法一：修改配置文件，永久生效

1. 若未做bond，则直接修改网卡配置
复制ifcfg-eth0 为 ifcfg-br0，并将ifcfg-br0改为如下配置
```
tee /etc/sysconfig/network-scripts/ifcfg-br0 <<EOF
TYPE=Bridge
BOOTPROTO=static
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
IPV4_FAILURE_FATAL=no
NAME=br0
DEVICE=br0
ONBOOT=yes
IPADDR=192.168.56.13
NETMASK=255.255.255.0
GATEWAY=192.168.56.2
EOF
```
原网卡ifcfg-em1只保留如下配置,其他都注释掉：
```
tee /etc/sysconfig/network-scripts/ifcfg-eth0<<EOF
NAME=eth0
DEVICE=eth0
ONBOOT=yes
BRIDGE=br0
EOF
```

2. 若做了bond，则做如下配置，至于bond的配置请看[往期博客，bond的配置](https://kaizamm.github.io/2018/05/16/linux%E7%9A%84bonding%E6%8A%80%E6%9C%AF/)
```
tee ifcfg-bond0 <<EOF
DEVICE=bond0
TYPE=Ethernet
NAME=bond0
BONDING_MASTER=yes
BOOTPROTO=none
BRIDGE=br0
ONBOOT=yes
BONDING_OPTS="mode=5 miimon=100"
EOF
```

重启网卡
```
systemctl restart network
```


方法二：

临时生效，通过ifconfig命令配置网卡及网桥参考[往期博客，网桥及路由配置](https://kaizamm.github.io/2018/05/21/linux%E4%B8%8B%E7%BD%91%E6%A1%A5%E5%8F%8A%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE/)


### 安装kvm
[参考](https://blog.csdn.net/wh211212/article/details/54141412)

安装kvm及管理工具
```
yum install -y kvm qemu-kvm python-virtinst libvirt libvirt-python virt-manager libguestfs-tools bridge-utils virt-install bridge-utils
```
+ kvm基础包
+ qemu-kvm:KVM模块
+ pyhon-virtinst： 包含python模块和工具（virt-install，virt-clone和virt-image），用于安装和克隆虚拟机使libvirt用。 它完全支持paravirtulized客人和客人虚拟客人。支持的虚拟机管理程序是Xen，qemu（QEMU）和kvm
+ libvirt: 虚拟管理模块
+ virt-manager: 图形界面管理虚拟机
+ libguestfs* : virt-cat等命令的支持软件包

4. 启动kvm
```
systemctl start libvirtd  &&  systemctl enable libvirtd
```

### 创建虚拟机

首先安装前要设置环境语言为英文LANG="en_US.UTF-8"，
```
#cat /etc/locale.conf
LANG="en_US.UTF-8"
```

通过网络在文本模式上安装GuestOS，虚拟机的映像默认放置在/var/lib/libvirt/images作为存储池，但本示例显示创建和使用新的存储池。

```
virt-install \
--name demo \
--memory 512 \
--disk path=/var/kvm/images/elk.img,size=30 \
--vcpus 1 \
--os-type linux \
--os-variant rhel7 \
--network bridge=br0 \
--graphics none \
--console pty,target_type=serial \
--location /tmp/CentOS-7-x86_64-Minimal-1804.iso \  
--extra-args 'console=ttyS0,115200n8 serial'
```

>上面指定的相关参数含义如下：更多参考man virt-install

```
--name  指定虚拟机的名称
--memory  指定虚拟机内存
--disk的内存量path = xxx，size = xxx
'path ='⇒指定虚拟机
size ='⇒指定虚拟机的磁盘数量
--vcpus 指定虚拟CPU
--os-type 指定GuestOS 的类型
--os-variant 指定GuestOS的类型 'fedora18', 'rhel7', 'winxp' - osinfo-query os 该命令可查看所有供选择的
--network 指定虚拟机的网络类型
--graphics 指定图形的类型。如果设置为“无”，则意味着非图形。
--console 指定控制台类型
--location 指定安装的位置，可以使用#--location 'http://mirrors.aliyun.com/centos/7/os/x86_64/' ，则使用网络地址
--extra-args 指定在内核中设置的参数
```


<img src="{{ '/styles/images/kvm20180524-1.png' | prepend: site.baseurl }}" alt="" width="610" />


```
virt-install -d --virt-type=kvm --name=aniu-saas-1  --vcpus=8 --memory=12288 --location=/media/CentOS-7-x86_64-Minimal-1611.iso --disk path=/dev/cl/aniu-saas-1 --network bridge=br0 --graphics none --extra-args='console=ttyS0' --force
```

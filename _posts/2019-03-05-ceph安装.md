---
layout: post
published: true
title:  存储介绍
categories: [document]
tags: [存储]
---
* content
{:toc}

### 前言
[官网](http://docs.ceph.com/docs/master/start/)，ceph安装

### 实验环境
通过vagrant搭建4台机器node1~4  
其中node2,3,4作osd，在vagrant创建完的机器后，需要打开virtualbox各新增一块磁盘，sdb。  
vagrantfile如下：  
```bash
## files: Vagrantfile
# -*- mode: ruby -*-
# vi: set ft=ruby :
hosts = {
  "node1" => "192.168.0.11",
  "node2" => "192.168.0.12",
  "node3" => "192.168.0.13",
  "node4" => "192.168.0.14",
  "node5" => "192.168.0.15"
}

Vagrant.configure("2") do |config|
  config.vm.box = "bento/centos-7.2"
  config.vm.box_url = "./vagrant-centos-7.2.box"
  config.vm.provider "virtualbox" do |v|
    v.customize ["modifyvm",:id,"--memory",3072]
  end
  hosts.each do |name, ip|
    config.vm.define name do |nodes|
      nodes.vm.hostname = name
      nodes.vm.network :private_network, ip: ip
      nodes.vm.provision "shell",
        run: "always",
        inline: "sudo ifup enp0s8; export LC_ALL=en_US.UTF-8; export LANG=en_US.UTF-8"
      end
    end
  end
```

### ceph-deploy安装
```bash
yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm

# 配置源，ceph-stable-release变量取值当前稳定版本，如luminous
cat << EOM > /etc/yum.repos.d/ceph.repo
[ceph-noarch]
name=Ceph noarch packages
#baseurl=https://download.ceph.com/rpm-{ceph-stable-release}/el7/noarch
baseurl=https://download.ceph.com/rpm-luminous/el7/noarch
enabled=1
gpgcheck=1
type=rpm-md
gpgkey=https://download.ceph.com/keys/release.asc
EOM

yum update
yum install ceph-deploy
yum install ntp ntpdate ntp-doc
yum install openssh-server

#创建一个ceph deploy user，配置无密码及sudo权限
#在每个节点执行
useradd ceph
echo 'ceph' | passwd --stdin ceph
echo "ceph ALL = (root) NOPASSWD:ALL" > /etc/sudoers.d/ceph
chmod 0440 /etc/sudoers.d/ceph
# 配置sshd可以使用password登录
sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
systemctl reload sshd
# 配置sudo不需要tty
sed -i 's/Default requiretty/#Default requiretty/' /etc/sudoers

#配置hosts
cat > /etc/hosts<<EOF
192.168.0.14 node4 node4
192.168.0.13 node3 node3
192.168.0.12 node2 node2
192.168.0.11 node1 node1
EOF

#配免密
#登陆至node1
su - ceph
ssh-keygen
ssh-copy-id ceph@node2
ssh-copy-id ceph@node3
ssh-copy-id ceph@node4

#开防火墙端口
#配置完成后，记得service iptables save
#同理，如果是firewalld类似
# ceph moinitor:6789  
# ceph OSDS: 6800:7300
#iptables -A INPUT -i {iface} -p tcp -s {ip-address}/{netmask} --dport 6789 -j ACCEPT
或
#firewall-cmd --add-port 6789/tcp --permanent
或者直接关闭iptables,firewalld,selinx
systemctl stop firewalld && systemctl disable firewalld
setenforce 0

```

至此，这准备阶段已经完成，现在看下这个部署架构  
![](/styles/images/ceph-deploy01.png)

由于是第一次搭建，先创建一个ceph存储集群：一个moinitor+3个ceph OSD。后续如果要扩展，再加第四个OSD，一个metadata 服务，两个mointor。



### 部署

```bash
su - ceph
mkdir my-cluster
cd my-cluster
#创建cluster,指定hostname
#如果在执行时提示无法找到pkg-packages时，需要yum install python-setuptools -y
ceph-deploy new node1 node2  node3
#执行ceph-deploy install node时，其实就是在对应结点上，安装ceph ceph-radosgw这两个包
ceph-deploy install node1 node2 node3
#部署monitor和生成keys
ceph-deploy mon create-initial
#复制配置文件和key到node节点，方便执行命令时不用指定monitor地址和keyring
ceph-deploy admin node2 node3 node4
ceph-deploy mgr create node2 #该条命令是Deploy a manager daemon. (Required only for luminous+ builds):
#创建三个osd，所谓osd，即存储介质，
ceph-deploy osd create --data /dev/sdb node2
ceph-deploy osd create --data /dev/sdb node3
ceph-deploy osd create --data /dev/sdb node4
#以下，如果在执行健康检查时候，一直没有health_ok，基本上就是时钟不对，需要开启时钟同步。
ssh node1 sudo ceph health
ssh node1 sudo ceph -s
```

### 清理集群

```
#至此，如果安装失败，需要清除，重新开始
ceph-deploy purge ceph-node-1 ceph-node-2 ceph-node-3
ceph-deploy purgedata ceph-node-1 ceph-node-2 ceph-node-3
ceph-deploy forgetkeys
rm ceph.*
```

### 扩展
基础的集群搭建完成后，需要扩展。在node2上增加一个metadata server，在node3和node4上加一个ceph monitor和manager；增加高可靠

![](/styles/images/ceph-deploy-expanding.png)
上图取自官网，对应实验环境的node2,3,4


```bash
#如果要用cephFS，即如果要用文件存储，需要安装这个mds
ceph-deploy mds create node2
#加Monitor，高可用需要，Paxos算法
ceph-deploy mon add node3
ceph-deploy mon add node4
#如果你加了ceph mointor，ceph将开始同步多个Monitor之间的数据，检查monitors状态
ceph quorum_status --format json-pretty
#增加managers，主从模式
ceph-deploy mgr create node3 node4
#查看standby manager，其实是查看ceph，所有的参数。
ssh node2 sudo ceph -s
#增加一个RGW 实例，监听7480
ceph-deploy rgw create node2
```

### 存取对象数据
在集群里面存一个对象数据，必须设置一个对象名字、指定一个pool。客户端检索最新的集群地图并通过CRUSH算法计算出对象到placement group的映射关系，并且动态计算出placement group到OSD之间的绑定。因此如果要找到对象的位置，你只需要知道<font color=red>object name及pool name</font>
```bash
echo {Test-data} > testfile.txt
ceph osd pool create mytest 8
rados put {object-name} {file-path} --pool=mytest
rados put test-object-1 testfile.txt --pool=mytest
rados -p mytest ls
ceph osd map {pool-name} {object-name}
ceph osd map mytest test-object-1
```

实验如下：         

```bash
echo "fuck fuck!!" > testfile.txt
#创建pool
[root@node2 ~]# ceph osd pool create mytest 8
pool 'mytest' created
#rados put {object name} {file-path} --pool=mytest，存数据
[root@node2 ~]# rados put test-object-1 testfile.txt --pool=mytest
#查看对应pool里的数据
[root@node2 ~]# rados -p mytest ls
test-object-1
#查看它的映射关系
[root@node2 ~]# ceph osd map mytest test-object-1
osdmap e31 pool 'mytest' (5) object 'test-object-1' -> pg 5.74dc35e2 (5.2) -> up ([1,0,2], p1) acting ([1,0,2], p1)
#删除Mytest pool，需要删除两次，让你确认。
[root@node2 ~]# ceph osd pool rm mytest
Error EPERM: WARNING: this will *PERMANENTLY DESTROY* all data stored in pool mytest.  If you are *ABSOLUTELY CERTAIN* that is what you want, pass the pool name *twice*, followed by --yes-i-really-really-mean-it.
[root@node2 ~]# ceph osd map mytest test-object-1
osdmap e31 pool 'mytest' (5) object 'test-object-1' -> pg 5.74dc35e2 (5.2) -> up ([1,0,2], p1) acting ([1,0,2], p1)
```  

至此，环境初步搭建完毕。

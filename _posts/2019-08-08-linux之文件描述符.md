---
layout: post
published: false
title:  linux之文件描述符及lsof
categories: [linux]
tags: [lsof,linux,文件描述符]
---
* content
{:toc}

# 前言
前段时间，突然被同事问到如何实现一个文件的锁的问题；在同事提供的百度出的示例代码里面有个用shell实现的方式；我刚百度提供的方法是用shell的flock命令来实现，通过查询文件inode的文件描述符，来实现。但是他提供的方法是利用expect的重定向来实现的，具体实现没记太清，有空百度出来后，再来补上；但是当时他提到了查询文件的描述符，关于我文件，我说对于文件应该是通过查询inode来实现，但说不出所以然，在此记录下文件描述符的笔记，增强记忆。

# 文件描述符
在Linux系统中一切皆可以看成是文件，文件又可分为：普通文件、目录文件、链接文件和设备文件。文件描述符（file descriptor）是内核为了高效管理已被打开的文件所创建的索引，其是一个非负整数（通常是小整数），用于指代被打开的文件，所有执行I/O操作的系统调用都通过文件描述符。程序刚刚启动的时候，0是标准输入，1是标准输出，2是标准错误。如果此时去打开一个新的文件，它的文件描述符会是3。POSIX标准要求每次打开文件时（含socket）必须使用当前进程中最小可用的文件描述符号码，因此，在网络通信过程中稍不注意就有可能造成串话

# Too many open files的问题
这主要是因为文件描述符是系统的一个重要资源，虽然说系统内存有多少就可以打开多少的文件描述符，但是在实际实现过程中内核是会做相应的处理的，一般最大打开文件数会是系统内存的10%（以KB来计算）（称之为系统级限制），查看系统级别的最大打开文件数可以使用sysctl -a | grep fs.file-max命令查看。与此同时，内核为了不让某一个进程消耗掉所有的文件资源，其也会对单个进程最大打开文件数做默认值处理（称之为用户级限制），默认值一般是1024，使用ulimit -n命令可以查看。在Web服务器中，通过更改系统默认值文件描述符的最大值来优化服务器是最常见的方式之一

# 文件描述符合打开文件之间的关系
每一个文件描述符会与一个打开文件相对应

# lsof
lsof: list opened file:列出打开的文件，它最大的作用就是显示进程打开的文件、或是查看打开的文件是属于哪个进程的；由于Linux中一切皆文件，它可以查看网络套接字、即查看某个端口是由哪个进程打开的；另外，如果有个程序一直在运行，但是有人人为删除它的日志，而该日志文件一直被该程序打开，那么该打开的文件内容其实都可以通过在/proc/pid/fd中看到，文件描述符，0 1 2 ；0代表输入 1代表正常输出 2错误输出；

# 显示某个目录(opt)下打开的所有文件
`lsof /opt` :结尾不带/；如果是指定目录，那么要加 +d参数(不递归到子目录，即只看这个目录)，如果要递归到子目录，则用+D。

# 查看某个进程（pid 605）打开的文件，不显示代码片段
`lsof -a -p 605 -d ^txt`
其中，-a是表示and，即后面两项做与，同时满足才显示。 -p 进程ID，-d 标志fd列进行筛选。^表示排除。

# 显示某个文件的打开程序（或叫显示某个文件的打开进程）
`lsof /var/run/sendmail.pid`

# 查看某个网络端口的进程
`lsof -i:25`
其实可以用 `protocol:@ip:port`的形式传递相关消息。其中的 protocol 为 TCP 或 UDP（可以使用 4 或 6 作为前缀，表示 IP 的版本），IP 为可解析的名称或 IP 地址，而 port 为数字或表示该服务的名称（来自 /etc/services）。需要一个或多个元素（端口、IP、协议）。在清单 8 中，:25 表示端口 25。输出显示，进程 605 正在使用 IPv6 和 IPv4 监听端口 25。如果您对 IPv4 不感兴趣，那么可以将筛选器改为 6:25，以表示监听端口 25 的 IPv6 套接字，或者直接使用 6 表示所有的 IPv6 连接。

# 搜索活动的连接
`lsof -i @192.168.1.10`

参考

https://www.ibm.com/developerworks/cn/aix/library/au-lsof.html

https://blog.csdn.net/sybnfkn040601/article/details/73718332

---
layout: post
published: true
title: 关于证书加密
categories: [document]
tags: [go]
---
* content
{:toc}

## 前言

最近搞istio升级时，经常碰到mTLS加密的问题。恰好最近有同事问到双向加密的事情，感觉每次都是看完当时懂，过后又感觉只是一知半解，讲不清楚。此次做个总结。

## 什么是对称加密？

**加密解密使用同一个密钥**

加密速度快

问题：客户端与服务端如何使用同一个密钥？

encrypt(明文，秘钥) = 密文

decrypt(密文，秘钥) = 明文

## 什么是非对称加密？

**非对称加密，有公私钥之分**

加密速度慢

公钥加密的数据，则只能用私钥来解密（加密）；

私钥加密的数据，只能用公钥来解密（签名）。

公钥是可以公开的密钥，可以在网络上传输。

由于加密速度慢，通常会结束对称加密一起使用。

**通过非对称加密方式，传递对称加密的私钥；真正的通信使用对称加密**

## 什么是mtls?

mtls即双向认证  

客户端验需要证服务器端证书： 如在访问https的时候，使用`curl -k`可以跳过客户端对服务端证书的验证。服务端生成证书+密钥，客户端校验服务端的证书。在通过浏览器访问https加密网站的时候，服务端会把它的证书发给客户端，浏览器内置的CA根证书会校验该证书的过期时间、域名地址等是否合法。

服务端需要验证客户端证书：双向认证会多这一步，此时客户端需要带上自己的证书+密钥来访问服务端。

如下：

```bash
[root@ssa3 ~]# curl https://127.0.0.1:2379/version --cacert /etc/ssl/etcd/ssl/ca.pem --cert /etc/ssl/etcd/ssl/admin-ssa3.pem   --key /etc/ssl/etcd/ssl/admin-ssa3-key.pem
{"etcdserver":"3.3.12","etcdcluster":"3.3.0"}
```

## 在访问https网页的时候，具体是怎样的传输过程？

![单向认证](/images/单向加密.jpg)
![双向认证](/images/双向加密.jpg)

> 思考：早期网银给你一个数字证书，需要自己安装在浏览器上面，这个证书是什么证书？
> 1. 有可能是ca证书，如果早期银行的证书不在浏览器上的CA根证书链里面，此时服务器发过来公钥（即证书），此时浏览器不识别，就会导致连接不成功。
> 2. 有没有可能是双向认证，这个证书是客户端证书，对客户端数据加密后让服务端来验证客户的证书？  ---  感觉这种可能性不大，因为一般需要证书+密钥，缺密钥。

## 什么是jwt?

`jwt` 令牌

[签名、摘要、加密](http://icyfenix.cn/architect-perspective/general-architecture/system-security/transport-security.html#%E6%91%98%E8%A6%81%E3%80%81%E5%8A%A0%E5%AF%86%E4%B8%8E%E7%AD%BE%E5%90%8D)

加密可逆：通过公钥加密的内容，通过私钥解密

摘要：摘要是惟一的标识，例如从网上下载镜像，会附带md5校验值。但是不能用这个md5值推导出镜像。

也称之为数字摘要（Digital Digest）或数字指纹（Digital Fingerprint）。JWT令牌中默认的签名信息是对令牌头、负载和密钥三者通过令牌头中指定的哈希算法（HMAC SHA256）计算出来的摘要值。

私钥加密，公钥解密，这种就是签名

## 什么是证书？

访问掘金，点击https的锁头，查看证书。
可以看到根证书/中级证书，然后到自已这个证书。

![证书](/styles/images/证书.jpg)

## 如何生成证书？

参考istio如何生成证书的，有完整的方法

<https://istio.io/latest/docs/tasks/traffic-management/ingress/secure-ingress/#generate-client-and-server-certificates-and-keys>

## 参考

<http://icyfenix.cn/architect-perspective/general-architecture/system-security/transport-security.html>  
<https://www.jianshu.com/p/29e0ba31fb8d>

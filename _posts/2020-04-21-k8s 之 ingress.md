---
layout: post
published: true
title:  ingress
categories: [k8s]
tags: []
---
* content
{:toc}

# 前言

频繁看到要对 url 估 rewrite，现在把它弄下，看下分别用 k8s的 ingress 和 istio 的 virtual service 实现下。另外需要搞清楚，如何来针对不同的需求，快速在官网找到示例来实现。

# ingress

https://kubernetes.io/docs/concepts/services-networking/ingress/


ingress 是流量进入 k8s 时的入口。可以针对 ingress是七层匹配，可以针对这个 url 做一些 uri path header  的 match。可以提供 lb 、 ssl 卸载、基于域名的路由（官网说是 ssl 终结、基于域名的托管，感觉翻译不准确）。

外面在访问的时候，肯定是要访问 service，在 service 之上会有个 ingress。

只部署一个 ingress 实例是没有用的，还需要有个 ingress controller。如 ingress-nginx。其它的一些 controller，如 istio-ingress、haproxy ingresst等。

一个最简单的 ingress yaml

```
$ echo '
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
  name: rewrite
  namespace: default
spec:
  rules:
  - host: rewrite.bar.com
    http:
      paths:
      - backend:
          serviceName: http-svc
          servicePort: 80
        path: /something(/|$)(.*)
' | kubectl create -f -
```
看上面的定义，apiVersion/kind/metadata/spec 四元组是必须的。看 spec 可以看到匹配 path,流量走向 test 这个 service，端口为 80。需要注意的是这个 name 必须要在 dns 中能解析。

看 annotations，可以看到可以对它进行 rewrite。关于 rewrite, k8s 的项目下面有这个的[介绍](https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/rewrite/README.md)


那么看这个 rewrite 是个值，然而一般的 rewrite 是对 url 要么是去掉后缀、要么是增加子项，那这个通过一个 value 的值如何来实现呢？

value是在这个地方写最终要转换成的 url 的形式，可以引用位置变量。具体匹配是在 spec/rules/paths/path这个地方能通过正则匹配组来实现的。

像上面的，第二个小括号里面的才会生效。

另外还可以指定 app-root

```
Create an Ingress rule with a app-root annotation:

$ echo "
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/app-root: /app1
  name: approot
  namespace: default
spec:
  rules:
  - host: approot.bar.com
    http:
      paths:
      - backend:
          serviceName: http-svc
          servicePort: 80
        path: /
" | kubectl create -f -
Check the rewrite is working

$ curl -I -k http://approot.bar.com/
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.11.10
Date: Mon, 13 Mar 2017 14:57:15 GMT
Content-Type: text/html
Content-Length: 162
Location: http://stickyingress.example.com/app1
Connection: keep-alive
```
app root什么意思？意思就是重定向另外一个 Url。

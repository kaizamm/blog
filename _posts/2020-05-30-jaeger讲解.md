---
layout: post
published: true
title:  jaeger讲解
categories: [servicemesh]
tags: []
---
* content
{:toc}

## 前言

青云的 istio 用了 jaeger 做链路追踪，最近 jaeger 也从 cncf 毕业了，现在研究下这个。

[官网](https://www.jaegertracing.io/)

## 介绍

jaeger 是uber 的一个分布式链路追踪系统，根据 dapper 和 zipkin 演化过来的。  
随着向微服务的架构迁移，问题主要集中在网络和可观察性上面。  
jaeger 有以下功能：

分布式事务监控

性能和延迟最优化

根本原因分析

服务依赖分析

distributed context propagation

jaeger 的部署方式有很多种，可以单独二进制方式部署，也可以以 docker 的方式单独部署。下面看下与 k8s 部署的方式。

## architeture

span: 一个 span 代表一个在 jaeger 中工作的一个逻辑单元，有一个 operation name,开始时间，和持续时间。

trace

这里只提供了直接存储到后端的图
![jaeger-architecture-v1](/styles/images/jaeger-architecture-v1.png)

官网还提供了一个用 kafka 作为缓存的架构图，这里省略。

agent: jaeger agent 是个通过 udp 通信的、监听 spans 的网络 daemon，按批次发给 collector。作为一个基础设施的组件，需要在所有的 Host 上安装。将 client 的路由发现上报给 collector。

collector: 从 jaeger agent 接收 traces，并且以流水线的形式来运行。pipeline 验证 traces，并给它们建索引，转换并最终存储。

Query: 是一个查询traces 的服务

Ingress: 它是从 kafa topic 接收消息，并将它写入到其他的存储后端。

## 在k8s中安装

## 关于Jaeger配置

采样配置有几种策略可以配置，可以设置Tracing全部/部分/随机，[sampling 配置](https://www.jaegertracing.io/docs/1.20/sampling/)

```bash
kubectl -n istio-system get cm jaeger-sampling-configuration -oyaml 
  ...
  sampling: '{"default_strategy":{"param":1,"type":"probabilistic"}}'  # 表示随机采样，但是比例是100%
```

如果一个请求需要被Jaeger Traing，那么这个请求一定需要一个X-Request-ID Header。且在该请求访问链中所有的工作负载都需要注入sidecar，将该ID记录到Jager。如下：通过curl指定Header中的requestID，页面上就能看到这个request的Tracing:

```bash
curl -H 'X-Request-ID: 56955ffa-4000-9e1e-bd53-50a41b825ea0' 'ssa2:31234/productpage?u=test'
```

> Tracing功能并非一定需要一个Ingress，只不过kubernetes ingress contrlloer默认会给一个请求生成requestID, [配置参数](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/)，如果需要另外一些参数，如增加X-Forward-For等，可以在ingress controller configmap的data中设置。
> 该Ingress Controller需要注入sidecar的原因是需要将访问链中的所有的X-Request-ID都记录到Jaeger

[Jaeger可以单独有一个sidecar，注入到应用；也可以是一个volume让负载来挂载](https://www.jaegertracing.io/docs/1.21/operator/)；[或是跟istio sidecar集成，需要给Istio的proxyconfig传入Jaeger的配置](https://istio.io/latest/docs/ops/integrations/jaeger/)。

## 疑问

在使用istio sidecar集成Jaeger的时候，留下一个疑问：

ingress controller

注入sidecar:

经过ingress controller后访问，Tracing是整个链路的，但是如果只是通过入口服务来访问，带上X-Request-ID，只能是这一个服务有Tracing；

不注入sidecar：

此时通过ingress controller来访问，发现在ingress controller在访问productpage时，Header中也带了request-id，但是Productpage却没有Tracing，为什么？

如下是controller在访问productpage的包：

![](/images/2020-12-10-18-57-53.png)

## 附

istio默认会使用mutual TLS加密，需要把tls禁掉才能抓到该包

```bash
kind: DestinationRule
metadata:
  name: redis-disable-mtls
spec:
  host: redis.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: DISABLE
```
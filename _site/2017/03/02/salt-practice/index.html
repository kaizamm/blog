<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>salt-practice - Think Deep,Work Lean</title>

	<link rel="shortcut icon" href="/styles/images/favicon.jpg">
	<link rel="icon" href="/styles/images/favicon.jpg">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="stylesheet" href="/styles/css/syntax.css">
	<link rel="canonical" href="/2017/03/02/salt-practice/">
	<link rel="alternate" type="application/rss+xml" title="Think Deep,Work Lean" href="/feed.xml">
	
	<meta name="keywords" content="salt-practice, Think Deep,Work Lean, 张凯:逆水行舟,不进则退;取法乎上，仅得其中；取法乎中，仅得其下;究天人之际，通古今之变，成一家之言">
	<meta name="description" content="张凯:逆水行舟,不进则退;取法乎上，仅得其中；取法乎中，仅得其下;究天人之际，通古今之变，成一家之言">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?a81273dded286ab83c533a4184e6ae8c";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <img src="/styles/images/logo.jpg">
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">大类分解</a>
        </li>
        <li>
          <a href="/tag">小类内聚</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
            <a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></a>
        </li>
        <li>
          <a href="/donate/"><strong>打赏</strong></a>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/kaizamm">Github</a></li>
            <li><a rel="nofollow" target="_blank" href="">关于作者</a></li>
            <li><a rel="nofollow" href="/books">我的书单</a></li>
            <li><a rel="nofollow" href="http://www.hifreud.com/domains/">域名管理</a></li>
            <li><a rel="nofollow" href="/reference">推荐博客</a></li>
            <li><a href="/feed.xml">RSS订阅</a></li>
            <li class="divider"></li>
            <li><a rel="nofollow" target="_blank" href="https://github.com/luoyan35714/LessOrMore.git">本项目</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>salt-practice</h1>
		    <p>Post on Mar 02, 2017 by <a href="/about">Kaiz</a></p>
		-->
		    <h1>Talk is cheap, show me code.</h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#document-ref">document</a>	/
    	<a href="/tag/#salt-ref">salt</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
  </ul>
  <div style="height: 200px;width: 200px;">
    <script type="text/javascript" src="//rf.revolvermaps.com/0/0/8.js?i=5ytn1ssq6za&amp;m=0&amp;c=ff0000&amp;cr1=ffffff&amp;f=arial&amp;l=33" async="async"> 
    </script>
  </div>
</div>

 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">salt-practice</h1>
              <!--
                <p class="post-meta">Mar 2, 2017</p>
              -->
              <div class="meta">Posted on <span class="postdate">Mar 02, 2017</span> By <a target="_blank" href="https://kaizamm.github.com">Kaiz</a></div>
              <br />
            </header>
            <article class="post-content">
              <h3 id="概述">概述</h3>
<p>依赖zeromq，salt-master监听两个端口：4505/tcp，publist_port，提供远程执行命令发送功能；4506/tcp，ret_port，用于文件服务、认证、结果搜索等功能接口，master端口需开通4505、4506,minion端口无特定端口要开通，minion端通过订阅master端4505端口的消息，然后将消息通过master端的4506端口返回结果</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el7.noarch.rpm -y
yum clean expire-cache
yum install salt-master
yum install salt-minion
salt-master -l debug #查看debug信息
salt-minion -l debug #查看minion信息
salt-key -L #查看key
salt-key -A -y #签售证书
rpm -ql salt-master #查看安装时安装了哪些文件（yum）
</code></pre></div></div>

<blockquote>
  <p>注意：若安装有epel-release,请先卸载，又可能造成依赖安装不成功，salt官方已有审明</p>
</blockquote>

<h3 id="操作目标参数">操作目标参数</h3>
<p>Target options:</p>
<ul>
  <li>-E, –pcre 正则匹配</li>
  <li>-L, –list 列表匹配</li>
  <li>-G，–grain grain匹配</li>
  <li>–grain-pcre grains加正则匹配</li>
  <li>-N, –nodegroup 组匹配</li>
  <li>-R, –range 范围匹配</li>
  <li>-C, –compound 综合匹配</li>
  <li>-I, –pillar pillar值匹配</li>
  <li>-S, –ipcidr minions网段地址匹配</li>
</ul>

<h3 id="配置文件">配置文件</h3>
<p>/etc/salt/master</p>

<h3 id="远程执行模块">远程执行模块</h3>
<p>salt ‘目标机器’ 函数</p>

<ul>
  <li>salt ‘node2’ sys.list_modules #查看远程执行模块</li>
  <li>salt ‘node2’ sys.list_functions pkg #查看pkg执行模块中的所有函数</li>
  <li>salt ‘node2’ sys.list_state_modules #状态文件属于状态模块，查看所有状态模块</li>
  <li>salt ‘node2’ sys.list_state_functions pkg #查看pkg状态模块中的所有函数
    <h4 id="cmdrun模块">cmd.run模块</h4>
    <p>/usr/lib/python2.7/site-packages/salt/modules/cmdmod.py</p>
  </li>
  <li><code class="highlighter-rouge">salt 'node2' sys.doc cmd.run</code>   #查看函数说明</li>
  <li><code class="highlighter-rouge">salt 'node2' cmd.run "hostname"</code>   #举例</li>
  <li><code class="highlighter-rouge">salt 'node2' sys.list_functions cmd</code> #列出cmd模块的函数</li>
</ul>

<blockquote>
  <p>原理都是在匹配的目标机器上执行python模块中的函数，可以编写自己的python模块推送到minion上按上述方式执行</p>
  <h4 id="pkginstall">pkg.install</h4>
  <ul>
    <li><code class="highlighter-rouge">salt 'node2' pkg.install httpd</code></li>
  </ul>
</blockquote>

<h3 id="状态系统">状态系统</h3>
<p>状态系统通过sls文件描述minion要达到什么状态，底层由saltstack状态模块保证minion处于该状态。</p>
<ul>
  <li><code class="highlighter-rouge">salt 'node2' pkg.install httpd</code></li>
  <li>采用状态描述为
```
    <h1 id="cat-srvsaltapachesls">cat /srv/salt/apache.sls</h1>
    <p>install_httpd:
pkg.installed:</p>
    <ul>
      <li>name: httpd
```
<code class="highlighter-rouge">salt 'node2' state.apply apache</code></li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>两者都达到了在目标机器上部署httpd服务的目的，但是执行远程命令的方式每次都会执行相同的逻辑和指令，而状态文件则是根据描述让minion处于指定状态，当前状态和所需状态不同时才执行相关操作。</p>
</blockquote>

<h3 id="highstate">highstate</h3>
<p>通过top.sls作为入口，对模块和主机进行管理，用top.sls组织多个状态文件，对模块进行拆分和复用，实现环境的配置管理；file_roots默认只有一个base环境，/srv/salt，top.sls就在环境的根目录下。</p>

<p>https://github.com/kaizamm/blog/blob/master/1.png</p>

<h4 id="topsls">top.sls</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># cat /srv/salt/top.sls
base:
  '*':
    - myapp
</code></pre></div></div>
<p>top.sls中引用了myapp，它会按如下顺序引用：如果存在myapp.sls，则引用myapp.sls；如果不存在，则引用myapp目录下的init.sls。我们采用子目录的方式对目录进行规划。</p>

<p>在myapp/init.sls中include与myapp相关的各个状态文件（可以把它拆分成多个，在此处include）</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#cat /srv/salt/myapp/init.sls
include:
  - .myconf  
</code></pre></div></div>
<p>myconf对应与init.sls同目录的myconf.sls状态文件，在该文件中对minion的/tmp/myconf.txt状态进行描述。</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conf1:
  file.managed:
    - name: /tmp/myconf.txt
    - source: salt://myapp/files/myconf.txt
    - user: root
    - group: root
    - mode: 644
</code></pre></div></div>

<p>https://github.com/kaizamm/blog/blob/master/state-file-described.png</p>

<p>在myapp/files/myconf.txt中写入任意内容，执行如下命令让minion处于描述的状态。<code class="highlighter-rouge">salt 'node2' state.apply</code></p>

<p>参考：</p>
<ul>
  <li>https://docs.saltstack.com/en/latest/topics/tutorials/states_pt1.html</li>
  <li>https://docs.saltstack.com/en/latest/topics/tutorials/starting_states.html</li>
</ul>

<h3 id="grains">grains</h3>
<p>saltstack中记录minion静态信息的组件（os类型、cpu核数、内存大小、ip地址等），在minion启动时采集汇报给master，因此grains通常是存储的静态、不常变化的数据，存储在minon本地。minion可以操作自己的grains数据（增删改）可通过如下命令查看每项grains数据。
<code class="highlighter-rouge">salt 'node2' grains.items</code>。minions的grains信息是minions启动时采集汇报给master的。</p>
<ul>
  <li>查grains信息 <code class="highlighter-rouge">salt '*' sys.list_functions grains</code></li>
  <li>查看文档信息 <code class="highlighter-rouge">salt '*' sys.doc grains</code></li>
</ul>

<h3 id="pillar">pillar</h3>
<p>与grains类似，但pillar存储的相对经常变化的数据，存储在master本地。minion只能查看自己的pillar数据。可通过如下命令查看每项pillar数据： <code class="highlighter-rouge">salt '*' pillar.items</code></p>

<h3 id="jinja">jinja</h3>
<p>python模板引擎，通过与grains和pillar结合定义动态的配置。如，不同的minion通过fqdn可以获取各自不同的主机名</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#salt '*' grains.item fqdn
node3:
    ----------
    fqdn:
        node3
node2:
    ----------
    fqdn:
        node2
</code></pre></div></div>

<p>接下来我们可以通过grains创建动态配置，让每个目标机器中的/tmp/myconf.txt显示自己的主机名。修改状态文件中的file描述，指定template为jinja</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#cat dev/myappconf.sls
conf1:
  file.managed
    - name: /tmp/myconf.txt
    - source: salt://dev/myapp/files/myconf.txt
    - user: root
    - group: root
    - mode: 644
    - template: jinja
</code></pre></div></div>
<p>在source对应的文件中通过 的方式引用grains数据</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#cat dev/myapp/files/myconf.txt
[BASE] /srv/salt/dev
My hostname is 
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ssh node2
# cat /tmp/myconf.txt
[BASE] /srv/salt/dev
My hostname is node2
</code></pre></div></div>
<p>参考：</p>
<ul>
  <li>https://docs.saltstack.com/en/latest/topics/tutorials/states_pt3.html</li>
</ul>

<h3 id="多环境配置和管理">多环境配置和管理</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># file_roots:
  base:
     - /srv/salt/
   dev:
     - /srv/salt/dev/services
     - /srv/salt/dev/states
   prod:
     - /srv/salt/prod/services
     - /srv/salt/prod/states
</code></pre></div></div>
<p>在多环境下，每个环境的根目录下维护各自的top.sls</p>

<p>https://github.com/kaizamm/blog/blob/master/2.png</p>

<p>分别在base、dev、prod环境的myconf.txt中写入不同内容，执行如下命令让不同环境的Minion处于对应的描述状态</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>salt '*' state.apply  # 默认base环境
salt '*' state.apply saltenv=dev # dev环境
salt '*' state.apply saltenv=prod # prod环境
</code></pre></div></div>
<p>参考：</p>
<ul>
  <li>https://docs.saltstack.com/en/latest/topics/tutorials/states_pt4.html</li>
</ul>

<h3 id="总结">总结</h3>
<ul>
  <li>salt-call test.ping 在minion端运行该语句，查看本地Minion是否正常。在minion端可以通过salt-call service.status <service_name> 查看minion端发送给master的信息; 如：tomcat的daemon（/etc/init.d/tomcat）里在 case语法里需加入 status，以保证service tomcat status显示服务当前运行状态。</service_name></li>
  <li>salt state.service 可管理daemon程序，管理非daemon程序可用supervisor</li>
</ul>

            </article>
        </div>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2014-2018 <a href=""><code>Kaiz</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, themed from <a href="http://lesscss.cn/">Less</a>, refactored by <a href="http://www.hifreud.com/">Freud Kang</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/lessismore.js"></script>
<script src="/styles/js/application.js"></script>
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  </body>
</html>
